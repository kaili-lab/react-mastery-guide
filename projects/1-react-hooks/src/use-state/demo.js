// ============================================
// æ ¸å¿ƒæ•°æ®ç»“æ„
// ============================================

/**
 * componentFiber: æ¨¡æ‹Ÿ React ä¸­æ¯ä¸ªç»„ä»¶çš„ Fiber èŠ‚ç‚¹
 *
 * åœ¨çœŸå® React ä¸­ï¼Œæ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ª Fiber å¯¹è±¡æ¥å­˜å‚¨è¯¥ç»„ä»¶çš„æ‰€æœ‰ä¿¡æ¯
 * è¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒ Hooks ç›¸å…³çš„éƒ¨åˆ†
 */
let componentFiber = {
  // æŒ‡å‘ç¬¬ä¸€ä¸ª Hook èŠ‚ç‚¹ï¼ˆé“¾è¡¨çš„å¤´ï¼‰
  // è¿™æ˜¯å•å‘é“¾è¡¨ï¼Œå®ƒä¼šå§‹ç»ˆä¿å­˜ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™ä¸ªå€¼è¦ä¹ˆæ˜¯ä¸€ä¸ªhookå¯¹è±¡ï¼Œè¦ä¹ˆæ˜¯ null
  hooksChain: null,
  // åˆå§‹å€¼æ˜¯ nullï¼Œå› ä¸ºè¿˜æ²¡åˆ›å»ºä»»ä½• Hook
};

/**
  currentHook: å½“å‰æ­£åœ¨å¤„ç†çš„ Hook èŠ‚ç‚¹ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨å±€æŒ‡é’ˆï¼Œç”¨æ¥éå† Hooks é“¾è¡¨
  ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæŒ‡é’ˆï¼Ÿ
  - å› ä¸ºæ¯æ¬¡è°ƒç”¨ useStateï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“"ç°åœ¨åº”è¯¥è¯»å–/åˆ›å»ºé“¾è¡¨ä¸­çš„ç¬¬å‡ ä¸ªèŠ‚ç‚¹"
  - é€šè¿‡ç§»åŠ¨è¿™ä¸ªæŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰é¡ºåºè®¿é—®é“¾è¡¨

  ä¸ºä»€ä¹ˆæ˜¯å…¨å±€å˜é‡ï¼Ÿ
  - å› ä¸º useState æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°ï¼Œå®ƒéœ€è¦çŸ¥é“"å½“å‰æ¸²æŸ“åˆ°å“ªä¸ª Hook äº†"
  - åœ¨çœŸå® React ä¸­ï¼Œè¿™ä¸ªå˜é‡å« workInProgressHookï¼Œä¹Ÿæ˜¯å…¨å±€çš„
 */
let currentHook = null;

// =================== useState å®ç° =========================
/**
 * useState: åˆ›å»ºæˆ–å¤ç”¨ä¸€ä¸ªçŠ¶æ€
 *
 * @param {*} initialValue - åˆå§‹å€¼ï¼Œåªåœ¨é¦–æ¬¡æ¸²æŸ“æ—¶ä½¿ç”¨
 * @returns {Array} [å½“å‰å€¼, æ›´æ–°å‡½æ•°]
 */
function useState(initialValue) {
  // hook å˜é‡ï¼šç”¨æ¥å­˜å‚¨"æœ¬æ¬¡ useState è°ƒç”¨å¯¹åº”çš„ Hook èŠ‚ç‚¹"
  // Hooksé“¾è¡¨ä¸­å­˜å‚¨çš„æ˜¯stateçš„å€¼å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªHookçš„æŒ‡é’ˆ
  let hook;

  // ===== 1ï¸âƒ£æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­æ˜¯åˆ›å»ºæ–° Hook è¿˜æ˜¯å¤ç”¨å·²æœ‰çš„ Hook ====

  // ----- åˆ†æ”¯ 1ï¼šå¤„ç†ç¬¬ä¸€ä¸ª Hook -----
  /**
    currentHook === null è¯´æ˜ï¼š
    - è¦ä¹ˆæ˜¯é¦–æ¬¡renderï¼Œè¦ä¹ˆæ˜¯re-renderï¼Œåæ­£å®ƒè¡¨ç¤º æ¸²æŸ“å¼€å§‹äº†ï¼›
    - å› ä¸ºæ¯æ¬¡æ¸²æŸ“ã€é‡æ–°å¼€å§‹å‰ï¼Œä¼šæŠŠ currentHook é‡ç½®ä¸º null
   */
  if (currentHook === null) {
    // componentFiber.hooksChain === null è¯´æ˜ï¼š
    // é“¾è¡¨è¿˜ä¸å­˜åœ¨ï¼Œè¿™æ˜¯é¦–æ¬¡æ¸²æŸ“ï¼Œéœ€è¦åˆ›å»ºç¬¬ä¸€ä¸ª Hook èŠ‚ç‚¹
    // ğŸ”µ é¦–æ¬¡æ¸²æŸ“ï¼š
    if (componentFiber.hooksChain === null) {
      // åˆ›å»ºç¬¬ä¸€ä¸ª Hook èŠ‚ç‚¹
      hook = {
        value: initialValue, // ä¿å­˜ state çš„å€¼
        next: null, // æŒ‡å‘ä¸‹ä¸€ä¸ª Hookï¼ˆç°åœ¨è¿˜æ²¡æœ‰ï¼Œæ‰€ä»¥æ˜¯ nullï¼‰
      };

      // æŠŠè¿™ä¸ª Hook è®¾ç½®ä¸ºé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œåç»­ä¸ä¼šæ›´æ–°hooksChainæŒ‡é’ˆäº†,å› ä¸ºå®ƒéœ€è¦å§‹ç»ˆæŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
      componentFiber.hooksChain = hook;
    }
    // ğŸŸ¢ Re-renderï¼š
    // hooksChain ä¸ä¸ºnullï¼Œè¡¨ç¤ºé“¾è¡¨å·²å­˜åœ¨ï¼Œè¿™æ˜¯é‡æ–°æ¸²æŸ“é˜¶æ®µï¼›
    else {
      // ä¸ºä»€ä¹ˆä¸åˆ›å»ºæ–°çš„ï¼Ÿå› ä¸ºstateæ˜¯ç”¨æ¥è·¨è¶Šrenderä¿å­˜æ•°æ®çš„ï¼Œè¦åœ¨re-renderæ—¶ä¿æŒä¸å˜ï¼›
      hook = componentFiber.hooksChain;
    }
  }
  // ----- åˆ†æ”¯ 2ï¼šå¤„ç†å¤´èŠ‚ç‚¹ä¹‹åçš„èŠ‚ç‚¹ -----
  // åŒ…æ‹¬é¦–æ¬¡æ¸²æŸ“å’Œ Re-render ä¸¤ç§æƒ…å†µ
  else {
    // currentHook.next === null è¯´æ˜è¿™æ˜¯ğŸ”µ é¦–æ¬¡æ¸²æŸ“
    if (currentHook.next === null) {
      // åˆ›å»ºæ–° Hook èŠ‚ç‚¹ä½œä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹
      hook = {
        value: initialValue,
        next: null,
      };
      // æŠŠæ–°èŠ‚ç‚¹è¿æ¥åˆ°é“¾è¡¨ï¼šä¸Šä¸€ä¸ª Hook çš„ next æŒ‡å‘æ–°èŠ‚ç‚¹
      currentHook.next = hook;
    }
    // ğŸŸ¢ Re-renderï¼šä¸‹ä¸€ä¸ªèŠ‚ç‚¹å·²å­˜åœ¨
    else {
      // é‚£å°±ç§»åŠ¨æŒ‡é’ˆï¼Œå¤ç”¨èŠ‚ç‚¹è€Œéåˆ›å»ºèŠ‚ç‚¹
      hook = currentHook.next;
    }
  }

  /**
    â­ï¸ 2ï¸âƒ£æ ¸å¿ƒé€»è¾‘ï¼šç§»åŠ¨ currentHook è¿™ä¸ªæŒ‡é’ˆ

    æŠŠ currentHook æ›´æ–°ä¸ºå½“å‰å¤„ç†çš„ Hook
    è¿™æ ·ä¸‹æ¬¡è°ƒç”¨ useState æ—¶ï¼ŒcurrentHook å°±æŒ‡å‘äº†"ä¸Šä¸€ä¸ª Hook"
    ä¸‹æ¬¡è°ƒç”¨ä¼šèµ°åˆ° currentHook.nextï¼Œä¹Ÿå°±æ˜¯é“¾è¡¨çš„ä¸‹ä¸€ä¸ªä½ç½®

    è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Hooks å¿…é¡»æŒ‰é¡ºåºè°ƒç”¨ï¼
    æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè®©æŒ‡é’ˆå‘å‰ç§»åŠ¨ä¸€æ­¥
   */
  currentHook = hook;

  /**
    åˆ›å»º setState å‡½æ•°

    è¿™æ˜¯ä¸€ä¸ªé—­åŒ…å‡½æ•°ï¼š
    - å®ƒ"æ•è·"äº†å½“å‰çš„ hook å˜é‡ï¼Œå³ä½¿ useState å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼ŒsetState ä»ç„¶èƒ½è®¿é—®è¿™ä¸ª hook
    - è¿™å°±æ˜¯é—­åŒ…çš„ä½œç”¨ï¼šè®°ä½äº†å®ƒè¢«åˆ›å»ºæ—¶çš„ç¯å¢ƒ
   */
  const setState = (newValue) => {
    /**
      ä¸ºä»€ä¹ˆèƒ½ç›´æ¥ä¿®æ”¹ hook.valueï¼Ÿ
      - å› ä¸º hook æ˜¯å¯¹é“¾è¡¨ä¸­èŠ‚ç‚¹çš„å¼•ç”¨
      - ä¿®æ”¹ hook.value å°±æ˜¯ä¿®æ”¹é“¾è¡¨ä¸­ä¿å­˜çš„å€¼
      - é“¾è¡¨åœ¨ componentFiber ä¸­ï¼Œæ˜¯æŒä¹…åŒ–çš„
     */
    hook.value = newValue;

    /**
      è§¦å‘é‡æ–°æ¸²æŸ“

      åœ¨çœŸå® React ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨è°ƒåº¦å™¨ï¼ˆschedulerï¼‰
      æŠŠæ›´æ–°åŠ å…¥é˜Ÿåˆ—ï¼Œç„¶åå¼‚æ­¥æ‰§è¡Œæ¸²æŸ“
     */
    rerender();
  };

  // è¿”å› [å½“å‰å€¼, æ›´æ–°å‡½æ•°]
  return [hook.value, setState];
}

// ============================================
// æ¸²æŸ“å‡½æ•°
// ============================================

/**
 * render: æ¸²æŸ“ç»„ä»¶
 *
 * åœ¨çœŸå® React ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹è¦å¤æ‚å¾—å¤šï¼š
 * - æœ‰ reconciliationï¼ˆåè°ƒï¼‰é˜¶æ®µ
 * - æœ‰ commit é˜¶æ®µ
 * - æœ‰ä¼˜å…ˆçº§è°ƒåº¦
 *
 * ä½†æ ¸å¿ƒæ€æƒ³æ˜¯ä¸€æ ·çš„ï¼šé‡ç½®æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨ç»„ä»¶å‡½æ•°
 */
function render() {
  /**
   * â­ï¸ æ ¸å¿ƒæ“ä½œï¼šé‡ç½® currentHook æŒ‡é’ˆ
   *
   * ä¸ºä»€ä¹ˆè¦é‡ç½®ï¼Ÿ
   * - å› ä¸ºæ¯æ¬¡æ¸²æŸ“éƒ½è¦ä»é“¾è¡¨å¤´å¼€å§‹éå†
   * - currentHook = null è¡¨ç¤º"å‡†å¤‡å¤„ç†ç¬¬ä¸€ä¸ª Hook"
   * - ç¬¬ä¸€æ¬¡è°ƒç”¨ useState æ—¶ï¼Œä¼šè¿›å…¥ if (currentHook === null) åˆ†æ”¯
   *
   * è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Hooks å¿…é¡»æŒ‰ç›¸åŒé¡ºåºè°ƒç”¨ï¼
   * - é¦–æ¬¡æ¸²æŸ“ï¼šæŒ‰é¡ºåºåˆ›å»ºé“¾è¡¨
   * - Re-renderï¼šæŒ‰ç›¸åŒé¡ºåºéå†é“¾è¡¨
   * - å¦‚æœé¡ºåºå˜äº†ï¼ŒæŒ‡é’ˆä¼šæŒ‡å‘é”™è¯¯çš„ä½ç½®
   */
  currentHook = null;

  // è°ƒç”¨ç»„ä»¶å‡½æ•°
  // ç»„ä»¶å†…éƒ¨ä¼šè°ƒç”¨ useStateï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šç§»åŠ¨ currentHook æŒ‡é’ˆ
  MyComponent();
}

/**
 * rerender: è§¦å‘é‡æ–°æ¸²æŸ“
 *
 * åœ¨çœŸå® React ä¸­ï¼š
 * - setState ä¼šæŠŠæ›´æ–°æ”¾å…¥é˜Ÿåˆ—
 * - React ä¼šæ‰¹é‡å¤„ç†å¤šä¸ª setState
 * - ç„¶ååœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨ render
 *
 * è¿™é‡Œç®€åŒ–äº†ï¼Œç›´æ¥è°ƒç”¨ render
 */
function rerender() {
  render();
}

// ============================================
// ç¤ºä¾‹ç»„ä»¶ -- æ¼”ç¤ºç”¨çš„ç»„ä»¶
// ============================================

/**
 * MyComponent: ä¸€ä¸ªä½¿ç”¨ Hooks çš„ç»„ä»¶
 */
function MyComponent() {
  /**
   * è°ƒç”¨é¡ºåºåˆ†æï¼š
   *
   * é¦–æ¬¡æ¸²æŸ“ï¼š
   * 1. currentHook = null (render å‡½æ•°é‡ç½®çš„)
   * 2. è°ƒç”¨ useState('Kai')
   *    - currentHook === nullï¼Œä¸”é“¾è¡¨ä¸ºç©º
   *    - åˆ›å»º Hook0ï¼Œè®¾ç½®ä¸ºé“¾è¡¨å¤´
   *    - currentHook = Hook0
   * 3. è°ƒç”¨ useState(25)
   *    - currentHook === Hook0 (ä¸æ˜¯ null)
   *    - Hook0.next === null
   *    - åˆ›å»º Hook1ï¼Œè¿æ¥åˆ° Hook0
   *    - currentHook = Hook1
   * 4. è°ƒç”¨ useState('Developer')
   *    - currentHook === Hook1
   *    - Hook1.next === null
   *    - åˆ›å»º Hook2ï¼Œè¿æ¥åˆ° Hook1
   *    - currentHook = Hook2
   *
   * é“¾è¡¨ç»“æœï¼šHook0('Kai') â†’ Hook1(25) â†’ Hook2('Developer')
   *
   * â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   *
   * Re-renderï¼š
   * 1. currentHook = null (render å‡½æ•°é‡ç½®çš„)
   * 2. è°ƒç”¨ useState('Kai')
   *    - currentHook === nullï¼Œä½†é“¾è¡¨å·²å­˜åœ¨
   *    - hook = componentFiber.hooksChain (å¤ç”¨ Hook0)
   *    - currentHook = Hook0
   * 3. è°ƒç”¨ useState(25)
   *    - currentHook === Hook0
   *    - Hook0.next === Hook1 (å·²å­˜åœ¨)
   *    - hook = Hook0.next (å¤ç”¨ Hook1)
   *    - currentHook = Hook1
   * 4. è°ƒç”¨ useState('Developer')
   *    - currentHook === Hook1
   *    - Hook1.next === Hook2 (å·²å­˜åœ¨)
   *    - hook = Hook1.next (å¤ç”¨ Hook2)
   *    - currentHook = Hook2
   *
   * âœ… å®Œç¾åŒ¹é…ï¼æ¯ä¸ª useState éƒ½è¯»å–åˆ°äº†æ­£ç¡®çš„ Hook
   */
  const [name, setName] = useState("Kai");
  const [age, setAge] = useState(25);
  const [job, setJob] = useState("Developer");

  return { setName, setAge, setJob };
}

// ============================================
// é”™è¯¯ç¤ºä¾‹ï¼šæ¡ä»¶ Hook
// ============================================

let showExtra = true;

function BrokenComponent() {
  /**
   * è°ƒç”¨é¡ºåºåˆ†æï¼ˆé—®é¢˜æ¼”ç¤ºï¼‰ï¼š
   *
   * é¦–æ¬¡æ¸²æŸ“ (showExtra = true)ï¼š
   * 1. currentHook = null
   * 2. useState('Kai')    â†’ åˆ›å»º Hook0, currentHook = Hook0
   * 3. if (true) è¿›å…¥
   * 4. useState('Extra')  â†’ åˆ›å»º Hook1, currentHook = Hook1
   * 5. useState(25)       â†’ åˆ›å»º Hook2, currentHook = Hook2
   *
   * é“¾è¡¨ï¼šHook0('Kai') â†’ Hook1('Extra') â†’ Hook2(25)
   *
   * â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   *
   * Re-render (showExtra = false)ï¼š
   * 1. currentHook = null
   * 2. useState('Kai')    â†’ hook = Hook0 âœ… æ­£ç¡®
   *                         currentHook = Hook0
   * 3. if (false) ä¸è¿›å…¥  â†’ è·³è¿‡äº†ä¸€æ¬¡ useState è°ƒç”¨ï¼
   * 4. useState(25)       â†’ hook = Hook0.next = Hook1 âŒ é”™è¯¯ï¼
   *                         currentHook = Hook1
   *
   * âŒ é—®é¢˜ï¼š
   * - ç¬¬äºŒä¸ª useState(25) æœŸæœ›è¯»å– age çš„å€¼ (25)
   * - ä½†å®é™…è¯»å–åˆ°äº† Hook1ï¼Œå®ƒä¿å­˜çš„æ˜¯ extra çš„å€¼ ('Extra')
   * - Hook2 æ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°ï¼
   *
   * è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸èƒ½åœ¨æ¡ä»¶è¯­å¥ä¸­ä½¿ç”¨ Hooksï¼š
   * - æ¡ä»¶æ”¹å˜ â†’ useState è°ƒç”¨æ¬¡æ•°æ”¹å˜
   * - è°ƒç”¨æ¬¡æ•°æ”¹å˜ â†’ currentHook æŒ‡é’ˆç§»åŠ¨æ¬¡æ•°æ”¹å˜
   * - æŒ‡é’ˆç§»åŠ¨é”™ä½ â†’ è¯»å–åˆ°é”™è¯¯çš„ Hook èŠ‚ç‚¹
   */
  const [name, setName] = useState("Kai");

  if (showExtra) {
    const [extra, setExtra] = useState("Extra");
  }

  const [age, setAge] = useState(25);

  return { setName, setAge };
}

// ============================================
// å…³é”®ç‚¹æ€»ç»“
// ============================================

/**
  1. ä¸ºä»€ä¹ˆç”¨é“¾è¡¨ï¼Ÿ
    - ä¸çŸ¥é“ä¼šæœ‰å¤šå°‘ä¸ª Hookï¼Œé“¾è¡¨å¯ä»¥åŠ¨æ€æ‰©å±•
    - ç”¨æ•°ç»„ä¹Ÿå¯ä»¥ï¼ŒçœŸå® React æ—©æœŸç‰ˆæœ¬ç”¨çš„æ•°ç»„

  2. ä¸ºä»€ä¹ˆéœ€è¦ currentHook æŒ‡é’ˆï¼Ÿ
    - ç”¨æ¥è®°å½•"ç°åœ¨åº”è¯¥å¤„ç†é“¾è¡¨ä¸­çš„å“ªä¸ªèŠ‚ç‚¹"
    - æ¯æ¬¡ useState è°ƒç”¨ä¼šç§»åŠ¨æŒ‡é’ˆ
    - è¿™æ ·å¯ä»¥æŒ‰é¡ºåºåˆ›å»º/è¯»å– Hooks

  3. ä¸ºä»€ä¹ˆè¦é‡ç½® currentHookï¼Ÿ
    - å› ä¸ºæ¯æ¬¡æ¸²æŸ“éƒ½è¦ä»å¤´éå†é“¾è¡¨
    - é‡ç½®ä¸º null è¡¨ç¤º"å‡†å¤‡å¤„ç†ç¬¬ä¸€ä¸ª Hook"

  4. setState å¦‚ä½•å·¥ä½œï¼Ÿ
    - setState æ˜¯é—­åŒ…ï¼Œæ•è·äº†å¯¹åº” Hook èŠ‚ç‚¹çš„å¼•ç”¨
    - è°ƒç”¨æ—¶ç›´æ¥ä¿®æ”¹é“¾è¡¨ä¸­çš„å€¼
    - ç„¶åè§¦å‘ re-render

  5. ä¸ºä»€ä¹ˆä¸èƒ½ç”¨æ¡ä»¶è¯­å¥ï¼Ÿ
    - æ¡ä»¶æ”¹å˜ â†’ è°ƒç”¨æ¬¡æ•°æ”¹å˜
    - è°ƒç”¨æ¬¡æ•°æ”¹å˜ â†’ æŒ‡é’ˆç§»åŠ¨æ¬¡æ•°æ”¹å˜
    - æŒ‡é’ˆé”™ä½ â†’ è¯»å–é”™è¯¯çš„ Hook â†’ çŠ¶æ€æ··ä¹±

  6. React æ€ä¹ˆè¯†åˆ«ä¸åŒçš„ stateï¼Ÿ
    - âŒ ä¸æ˜¯é€šè¿‡å˜é‡åï¼ˆnameã€ageï¼‰
    - âœ… è€Œæ˜¯é€šè¿‡è°ƒç”¨é¡ºåºï¼ˆç¬¬0ä¸ªã€ç¬¬1ä¸ªã€ç¬¬2ä¸ªï¼‰
    - è¿™å°±æ˜¯ä¸ºä»€ä¹ˆé¡ºåºå¿…é¡»ä¸€è‡´ï¼
 */
